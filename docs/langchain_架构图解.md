# LangChain 架构图解

> 基于 LangChain 官方文档的准确架构图

---

## 一、核心执行流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      LangChain Agent 执行流程                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   用户输入请求    │
                    └──────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  构建调用参数                            │
        │  • Messages（消息列表）                  │
        │  • RunnableConfig（配置）                │
        │  • Context（上下文）                     │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │         Agent 执行循环开始               │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  步骤 1: Model Call（模型调用）          │
        │  ─────────────────────────────────       │
        │  输入: Messages + Tools + Config         │
        │  处理: LLM 推理决策                      │
        │  输出: AIMessage                         │
        │    ├─ 纯文本回复 → 结束循环              │
        │    └─ tool_calls → 继续执行              │
        └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  是否有工具调用？ │
                    └──────────────────┘
                       │            │
                   是  │            │ 否
                       ▼            ▼
        ┌──────────────────────┐  ┌──────────────┐
        │ 步骤 2: Tool Execute │  │  返回最终结果 │
        │ ──────────────────── │  └──────────────┘
        │ 输入: tool_calls     │
        │ 处理: 执行工具函数    │
        │ 输出: ToolMessage    │
        └──────────────────────┘
                       │
                       │ 循环
                       ▼
        ┌──────────────────────────────┐
        │  将 ToolMessage 追加到消息列表 │
        └──────────────────────────────┘
                       │
                       └──────┐
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │  重复步骤 1（带工具结果的新一轮推理）     │
        └─────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   最终输出结果    │
                    └──────────────────┘
```

**关键说明：**
- **Model Call**: 模型根据消息历史和可用工具做出决策
- **Tool Execute**: 执行模型请求的工具，返回结果
- **循环机制**: 持续执行直到模型决定不再调用工具

---

## 二、核心组件结构图

### 2.1 RunnableConfig（配置对象）

```
┌─────────────────────────────────────────────────────────────────┐
│                      RunnableConfig                             │
│                   （运行时配置对象）                             │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│ configurable │    │  callbacks   │      │   metadata   │
│ （可配置参数）│    │ （回调处理器）│      │  （元数据）   │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  • thread_id          • on_llm_start         • request_id
  • user_id            • on_tool_start        • session_id
  • 自定义配置          • on_llm_end           • user_id
                      • 自定义回调            • 追踪信息

        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│     tags     │    │  run_name    │      │max_concurrency│
│   （标签）    │    │ （运行名称）  │      │ （最大并发）  │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  • production         • "user_query"         • 5
  • debug              • "tool_search"        • 10
  • 分类标签            • 便于追踪             • 并发控制
```

### 2.2 Messages（消息对象）

```
┌─────────────────────────────────────────────────────────────────┐
│                         Messages                                │
│                    （消息列表 - 有序）                            │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│SystemMessage │    │ HumanMessage │      │  AIMessage   │
│ （系统消息）  │    │ （用户消息）  │      │ （AI 消息）  │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  • content            • content              • content
  • 定义 AI 行为       • 用户输入             • AI 回复
  • 设置角色           • name（可选）          • tool_calls（可选）
                                             • response_metadata

                              │
                              ▼
                    ┌──────────────┐
                    │ ToolMessage  │
                    │ （工具消息）  │
                    └──────────────┘
                              │
                              ▼
                      • content
                      • tool_call_id
                      • name
                      • 工具执行结果
```

### 2.3 Runtime（运行时对象）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Runtime 对象结构                              │
│              （LangGraph 暴露的运行时对象）                       │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│   Context    │    │    Store     │      │Stream Writer │
│ （静态配置）  │    │ （长期记忆）  │      │ （流式输出）  │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  作用域：会话级         作用域：跨会话         作用域：会话级
  
  内容：                内容：                内容：
  • user_id            • 用户偏好            • 自定义流式数据
  • api_key            • 历史记录            • 实时更新
  • permissions        • 提取的洞察          • custom 模式
  • db_connection      • 记忆数据            • 进度通知
  
  特点：                特点：                特点：
  • 不可变             • 持久化              • 实时流式
  • 静态信息           • 跨会话共享          • 自定义输出
  • 会话开始时设置      • 需要显式读写         • 用于监控

  访问方式：            访问方式：            访问方式：
  runtime.context      runtime.store         runtime.stream_writer
```

**注意：State 不在 Runtime 中**
- **State** 是 Agent 的状态对象，独立于 Runtime
- State 包含：messages、intermediate_steps 等会话数据
- State 通过 Agent 的状态管理机制访问，不是 Runtime 的一部分

---

## 三、Agent 数据访问架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                Agent 执行过程中的数据访问                         │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│   Runtime    │    │    State     │      │Checkpointer  │
│ （运行时对象）│    │ （状态对象）  │      │ （持久化）    │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  包含：                包含：                功能：
  • Context            • messages            • 自动保存 State
  • Store              • uploaded_files      • 会话恢复
  • Stream Writer      • auth_status         • 跨会话持久化
                      • tool_results        • 检查点管理
  
  作用域：              作用域：              作用域：
  会话级               会话级                跨会话
  
  访问方式：            访问方式：            访问方式：
  runtime.context      state["messages"]     自动管理
  runtime.store        state.get("key")      checkpointer.get()
  runtime.stream_writer state["key"] = val   checkpointer.put()
```

### Context Engineering（上下文工程）

```
┌─────────────────────────────────────────────────────────────────┐
│                   Context Engineering                           │
│                    （上下文工程）                                │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│Model Context │    │ Tool Context │      │Life-cycle    │
│ （模型上下文）│    │ （工具上下文）│      │   Context    │
└──────────────┘    └──────────────┘      └──────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
  控制内容：            控制内容：            控制内容：
  • System Prompt      • 工具读取数据         • 中间处理
  • Messages           • 工具写入数据         • 摘要
  • Tools              • 访问 Runtime        • 日志
  • Model              • 访问 State          • 守护规则
  • Response Format    • 更新 Store          • 监控
  
  持久性：临时          持久性：持久          持久性：持久
  
  实现方式：            实现方式：            实现方式：
  @wrap_model_call     ToolRuntime          Middleware
  
  数据源：              数据源：              数据源：
  • Runtime.context    • Runtime.context     • State
  • Runtime.store      • Runtime.store       • Runtime.store
  • State              • State               • Checkpointer
  
  示例：                示例：                示例：
  • 注入用户偏好        • 读取 API Key        • 自动摘要
  • 动态选择工具        • 保存用户数据         • 错误重试
  • 切换模型           • 访问数据库          • 性能监控
```

---

## 四、数据流转逻辑图

```
┌─────────────────────────────────────────────────────────────────┐
│                    完整数据流转过程                              │
└─────────────────────────────────────────────────────────────────┘

用户请求
   │
   ├─ Messages: [HumanMessage("查询天气")]
   ├─ Config: {configurable: {thread_id: "123"}}
   └─ Context: {user_id: "user_456", api_key: "sk-..."}
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  Middleware: 预处理（Life-cycle Context）                       │
│  • 从 Store 读取用户偏好                                         │
│  • 从 State 读取会话历史                                         │
│  • 注入到 Messages                                              │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  Model Call: 模型推理（Model Context）                          │
│  输入:                                                          │
│    • Messages: [System, Human, ...]                            │
│    • Tools: [search_tool, weather_tool]                        │
│    • Config: {temperature: 0.7}                                │
│  输出:                                                          │
│    • AIMessage(                                                │
│        content="",                                             │
│        tool_calls=[{                                           │
│          id: "call_123",                                       │
│          name: "weather_tool",                                 │
│          args: {city: "北京"}                                   │
│        }]                                                      │
│      )                                                         │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  Tool Execution: 工具执行（Tool Context）                       │
│  工具函数:                                                      │
│    def weather_tool(city, runtime: ToolRuntime):               │
│      # 读取 Runtime Context                                    │
│      api_key = runtime.context.api_key                         │
│      # 读取 Store                                              │
│      prefs = runtime.store.get(("prefs",), user_id)            │
│      # 执行查询                                                │
│      result = fetch_weather(city, api_key)                     │
│      # 写入 Store                                              │
│      runtime.store.put(("history",), user_id, query)           │
│      return result                                             │
│  输出:                                                          │
│    • ToolMessage(                                              │
│        content="北京：晴天，25°C",                              │
│        tool_call_id="call_123"                                 │
│      )                                                         │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  追加到消息列表                                                  │
│  Messages: [System, Human, AI(tool_calls), Tool]               │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  Model Call: 第二轮推理                                         │
│  输入: Messages（包含工具结果）                                  │
│  输出: AIMessage(content="北京今天是晴天，温度 25°C")            │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────────┐
│  Middleware: 后处理                                             │
│  • 保存到 State（短期记忆）                                      │
│  • 保存到 Checkpointer（持久化）                                │
│  • 触发回调（日志、监控）                                        │
└─────────────────────────────────────────────────────────────────┘
   │
   ▼
返回给用户
```

---

## 五、工具调用详细流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      工具调用完整流程                            │
└─────────────────────────────────────────────────────────────────┘

步骤 1: 定义工具
┌─────────────────────────────────────────────────────────────────┐
│  @tool                                                          │
│  def search_tool(                                               │
│      query: str,                    # LLM 可见参数              │
│      runtime: ToolRuntime[Context]  # 自动注入，LLM 不可见      │
│  ) -> str:                                                      │
│      """搜索网络内容"""                                          │
│      # 访问 Runtime Context                                     │
│      api_key = runtime.context.api_key                          │
│      # 访问 State                                               │
│      filters = runtime.state.get("filters")                     │
│      # 访问 Store                                               │
│      history = runtime.store.get(("history",), user_id)         │
│      # 执行搜索                                                 │
│      return perform_search(query, api_key, filters)             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
步骤 2: 绑定工具到模型
┌─────────────────────────────────────────────────────────────────┐
│  model_with_tools = model.bind_tools([search_tool])            │
│  # 或在 Agent 中                                                │
│  agent = create_agent(model, tools=[search_tool])              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
步骤 3: 模型决策调用工具
┌─────────────────────────────────────────────────────────────────┐
│  输入: "搜索 LangChain 文档"                                     │
│  模型输出: AIMessage(                                           │
│    content="",                                                 │
│    tool_calls=[{                                               │
│      id: "call_abc",                                           │
│      name: "search_tool",                                      │
│      args: {query: "LangChain 文档"}                            │
│    }]                                                          │
│  )                                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
步骤 4: Agent 执行工具
┌─────────────────────────────────────────────────────────────────┐
│  # Agent 自动调用工具函数                                        │
│  result = search_tool(                                          │
│      query="LangChain 文档",                                    │
│      runtime=ToolRuntime(                                       │
│          context=Context(...),                                  │
│          state=current_state,                                   │
│          store=store                                            │
│      )                                                          │
│  )                                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
步骤 5: 返回工具结果
┌─────────────────────────────────────────────────────────────────┐
│  ToolMessage(                                                   │
│      content="找到 10 条结果：...",                              │
│      tool_call_id="call_abc",                                   │
│      name="search_tool"                                         │
│  )                                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
步骤 6: 模型处理结果
┌─────────────────────────────────────────────────────────────────┐
│  输入: [Human, AI(tool_calls), Tool]                            │
│  模型输出: AIMessage(                                           │
│      content="我找到了 LangChain 的官方文档..."                  │
│  )                                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、关键概念速查

### 6.1 核心对象对比

| 对象 | 作用 | 作用域 | 可变性 | 访问方式 |
|------|------|--------|--------|----------|
| **RunnableConfig** | 运行时配置 | 单次调用 | 不可变 | `config` 参数 |
| **Messages** | 对话历史 | 会话级 | 可追加 | `state["messages"]` |
| **Runtime.context** | 静态配置 | 会话级 | 不可变 | `runtime.context` |
| **Runtime.store** | 长期记忆 | 跨会话 | 可变 | `runtime.store` |
| **Runtime.stream_writer** | 流式输出 | 会话级 | 可写 | `runtime.stream_writer` |
| **State** | 会话状态 | 会话级 | 可变 | `state["key"]` |
| **Checkpointer** | 持久化 | 跨会话 | 持久 | 自动保存 |

### 6.2 三种上下文对比

| 上下文类型 | 控制内容 | 持久性 | 实现方式 | 典型用途 |
|-----------|---------|--------|----------|----------|
| **Model Context** | 模型输入 | 临时 | `@wrap_model_call` | 动态提示词、工具选择 |
| **Tool Context** | 工具读写 | 持久 | `ToolRuntime` | 访问数据、保存结果 |
| **Life-cycle Context** | 中间处理 | 持久 | `Middleware` | 摘要、日志、监控 |

### 6.3 数据流向

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据流向图                                │
└─────────────────────────────────────────────────────────────────┘

Runtime Object (会话级)
├─ Context (静态配置) ──────┐
├─ Store (长期记忆) ────────┤
└─ Stream Writer (流式) ────┤
                           │
                           ├──> Tool 读取
                           │      │
State (会话状态) ───────────┤      ▼
├─ messages ───────────────┤   Tool 执行
├─ uploaded_files ─────────┤      │
└─ custom_data ────────────┘      ▼
                           ┌──────────────┐
                           │  Tool 写入   │
                           └──────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
            Update State    Write Store   Stream Output
                 │              │              │
                 ▼              ▼              ▼
            Checkpointer   跨会话持久化    实时反馈
            自动保存        用户偏好        进度通知
```

---

## 七、最佳实践图解

### 7.1 何时使用哪种数据源

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据源选择决策树                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │  数据是否会变化？  │
                    └─────────┬─────────┘
                       │            │
                   不变 │            │ 会变
                       ▼            ▼
            ┌──────────────┐  ┌──────────────┐
            │ Runtime      │  │ 是否跨会话？  │
            │ Context      │  └──────────────┘
            └──────────────┘         │
            • API Key               │
            • 用户 ID          ┌────┴────┐
            • DB 连接        是 │        │ 否
            • 权限              ▼        ▼
                    ┌──────────────┐  ┌──────────────┐
                    │ Runtime      │  │    State     │
                    │   Store      │  │  （会话状态） │
                    └──────────────┘  └──────────────┘
                    • 用户偏好         • messages
                    • 历史记录         • uploaded_files
                    • 提取洞察         • auth_status
                    • 记忆数据         • tool_results

                              │
                    ┌─────────┴─────────┐
                    │  需要实时输出？    │
                    └─────────┬─────────┘
                              │
                          是  │
                              ▼
                    ┌──────────────┐
                    │ Runtime      │
                    │Stream Writer │
                    └──────────────┘
                    • 进度通知
                    • 自定义流
                    • 实时反馈
```

### 7.2 上下文工程实施流程

```
1. 识别需求
   ↓
   需要动态调整模型输入？ ──是──> 使用 Model Context
   │                              (@wrap_model_call)
   否
   ↓
2. 工具需要访问数据？ ──是──> 使用 Tool Context
   │                          (ToolRuntime)
   否
   ↓
3. 需要中间处理？ ──是──> 使用 Life-cycle Context
   │                      (Middleware)
   否
   ↓
4. 使用默认流程
```

---

## 八、总结

### 核心要点

1. **执行流程**: Model Call → Tool Execute → 循环直到完成
2. **配置对象**: RunnableConfig 贯穿整个执行过程
3. **消息系统**: Messages 是输入输出的载体
4. **数据源**: Context（静态）、State（临时）、Store（持久）
5. **上下文工程**: 三种类型控制不同阶段的行为

### 架构特点

- **统一接口**: 所有组件实现 Runnable 接口
- **灵活配置**: 通过 RunnableConfig 动态控制
- **持久化**: Checkpointer 自动保存状态
- **可观测**: Callbacks 提供完整监控

### 参考文档

- **官方文档**: https://python.langchain.com/docs/
- **Context Engineering**: https://docs.langchain.com/oss/python/langchain/context-engineering
- **Tools**: https://docs.langchain.com/oss/python/langchain/tools
- **Models**: https://docs.langchain.com/oss/python/langchain/models
